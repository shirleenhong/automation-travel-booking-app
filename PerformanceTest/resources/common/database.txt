*** Settings ***
Resource          global_resources.txt

*** Keywords ***
Get Merchant Fee From DB
    [Arguments]    ${credit_card_vendor_code}    ${client_fee_group_name}
    Connect To Power Express Database    Desktop_Test
    ${queryResults}    Query    SELECT TOP 1 MF.MerchantFeePercent FROM (([dbo].[MerchantFee] MF INNER JOIN [dbo].[MerchantFeeClientFeeGroup] MFG ON MF.MerchantFeeId = MFG.MerchantFeeId) INNER JOIN [dbo].[ClientFeeGroup] CFG ON MFG.ClientFeeGroupId = CFG.ClientFeeGroupId AND CFG.ClientFeeGroupName = '${client_fee_group_name}') WHERE MF.CreditCardVendorCode = '${credit_card_vendor_code}'
    ${queryResults}    Convert To String    ${queryResults[0]}
    ${queryResults}    Remove All Non-Integer (retain period)    ${queryResults}
    Disconnect From Database
    [Return]    ${queryResults}

Get Transaction Fee From DB (From City)
    [Arguments]    ${client_fee_group_name}    ${transaction_type_code}    ${booking_origination_code}    ${travel_indicator}    ${from_city_code}    ${to_travelport_code}=${EMPTY}
    ...    ${to_city_code}=${EMPTY}    ${to_country_code}=${EMPTY}    ${to_sub_region_code}=${EMPTY}    ${to_region_code}=${EMPTY}    ${transaction_fee}=${EMPTY}    ${is_percentage}=False
    Connect To Power Express Database    Desktop_Test
    ${fee_value}    Set Variable If    "${is_percentage}" == "True"    FeePercent    FeeAmount
    ${queryResults}    Query    SELECT TOP 1 ${fee_value} FROM [dbo].[TransactionFee] TF INNER JOIN [dbo].[TransactionFeeClientFeeGroup] TFCG ON TF.TransactionFeeId = TFCG.TransactionFeeId INNER JOIN [dbo].[ClientFeeGroup] CFG ON CFG.ClientFeeGroupId = TFCG.ClientFeeGroupId AND CFG.ClientFeeGroupName = '${client_fee_group_name}' INNER JOIN [dbo].[BookingOrigination] BO ON BO.BookingOriginationCode = TF.BookingOriginationCode INNER JOIN [dbo].[PolicyRouting] PR ON PR.PolicyRoutingId = TF.PolicyRoutingId WHERE TF.TransactionTypeCode = '${transaction_type_code}' AND (TF.BookingOriginationCode = '${booking_origination_code}' OR TF.BookingOriginationCode = 'Any') AND TF.TravelIndicator = '${travel_indicator}' AND TF.TransactionFeeDescription like '%${transaction_fee}%' AND (PR.FromCityCode = '${from_city_code}' AND (PR.ToCityCode = '${to_city_code}' OR PR.ToCountryCode = '${to_country_code}' OR PR.ToTravelPortCode = '${to_travelport_code}' OR PR.ToGlobalRegionCode = '${to_region_code}' OR PR.ToGlobalSubRegionCode = '${to_sub_region_code}'))
    ${queryResults}    Convert To String    ${queryResults[0]}
    ${queryResults}    Remove All Non-Integer (retain period)    ${queryResults}
    Disconnect From Database
    [Return]    ${queryResults}

Get Transaction Fee From DB (From Country)
    [Arguments]    ${client_fee_group_name}    ${transaction_type_code}    ${booking_origination_code}    ${travel_indicator}    ${from_country_code}    ${to_travelport_code}=${EMPTY}
    ...    ${to_city_code}=${EMPTY}    ${to_country_code}=${EMPTY}    ${to_sub_region_code}=${EMPTY}    ${to_region_code}=${EMPTY}    ${transaction_fee}=${EMPTY}    ${is_percentage}=False
    Connect To Power Express Database    Desktop_Test
    ${fee_value}    Set Variable If    "${is_percentage}" == "True"    FeePercent    FeeAmount
    ${queryResults}    Query    SELECT TOP 1 ${fee_value} FROM [dbo].[TransactionFee] TF INNER JOIN [dbo].[TransactionFeeClientFeeGroup] TFCG ON TF.TransactionFeeId = TFCG.TransactionFeeId INNER JOIN [dbo].[ClientFeeGroup] CFG ON CFG.ClientFeeGroupId = TFCG.ClientFeeGroupId AND CFG.ClientFeeGroupName = '${client_fee_group_name}' INNER JOIN [dbo].[BookingOrigination] BO ON BO.BookingOriginationCode = TF.BookingOriginationCode INNER JOIN [dbo].[PolicyRouting] PR ON PR.PolicyRoutingId = TF.PolicyRoutingId WHERE TF.TransactionTypeCode = '${transaction_type_code}' AND (TF.BookingOriginationCode = '${booking_origination_code}' OR TF.BookingOriginationCode = 'Any') AND TF.TravelIndicator = '${travel_indicator}' AND TF.TransactionFee like '%${transaction_fee}%' AND (PR.FromCountryCode = '${from_country_code}' AND (PR.ToCityCode = '${to_city_code}' OR PR.ToCountryCode = '${to_country_code}' OR PR.ToTravelPortCode = '${to_travelport_code}' OR PR.ToGlobalRegionCode = '${to_region_code}' OR PR.ToGlobalSubRegionCode = '${to_sub_region_code}'))
    ${queryResults}    Convert To String    ${queryResults[0]}
    ${queryResults}    Remove All Non-Integer (retain period)    ${queryResults}
    Disconnect From Database
    [Return]    ${queryResults}

Get Transaction Fee From DB (From Global)
    [Arguments]    ${client_fee_group_name}    ${transaction_type_code}    ${booking_origination_code}    ${travel_indicator}    ${from_global_flag}    ${to_travelport_code}=${EMPTY}
    ...    ${to_city_code}=${EMPTY}    ${to_country_code}=${EMPTY}    ${to_sub_region_code}=${EMPTY}    ${to_region_code}=${EMPTY}    ${to_global_flag}=${EMPTY}    ${transaction_fee}=${EMPTY}
    ...    ${is_percentage}=False
    Connect To Power Express Database    Desktop_Test
    ${fee_value}    Set Variable If    "${is_percentage}" == "True"    FeePercent    FeeAmount
    ${queryResults}    Query    SELECT TOP 1 ${fee_value} FROM [dbo].[TransactionFee] TF INNER JOIN [dbo].[TransactionFeeClientFeeGroup] TFCG ON TF.TransactionFeeId = TFCG.TransactionFeeId INNER JOIN [dbo].[ClientFeeGroup] CFG ON CFG.ClientFeeGroupId = TFCG.ClientFeeGroupId AND CFG.ClientFeeGroupName = '${client_fee_group_name}' INNER JOIN [dbo].[BookingOrigination] BO ON BO.BookingOriginationCode = TF.BookingOriginationCode INNER JOIN [dbo].[PolicyRouting] PR ON PR.PolicyRoutingId = TF.PolicyRoutingId WHERE TF.TransactionTypeCode = '${transaction_type_code}' AND (TF.BookingOriginationCode = '${booking_origination_code}' OR TF.BookingOriginationCode = 'Any') AND TF.TravelIndicator = '${travel_indicator}' AND TF.TransactionFeeDescription like '%${transaction_fee}%' AND (PR.FromGlobalFlag = '${from_global_flag}' AND (PR.ToCityCode = '${to_city_code}' OR PR.ToCountryCode = '${to_country_code}' OR PR.ToTravelPortCode = '${to_travelport_code}' OR PR.ToGlobalRegionCode = '${to_region_code}' OR PR.ToGlobalSubRegionCode = '${to_sub_region_code}' OR PR.ToGlobalFlag = '${to_global_flag}'))
    ${queryResults}    Convert To String    ${queryResults[0]}
    ${queryResults}    Remove All Non-Integer (retain period)    ${queryResults}
    Disconnect From Database
    [Return]    ${queryResults}

Get Transaction Fee From DB (From Region)
    [Arguments]    ${client_fee_group_name}    ${transaction_type_code}    ${booking_origination_code}    ${travel_indicator}    ${from_region_code}    ${to_travelport_code}=${EMPTY}
    ...    ${to_city_code}=${EMPTY}    ${to_country_code}=${EMPTY}    ${to_sub_region_code}=${EMPTY}    ${to_region_code}=${EMPTY}    ${transaction_fee}=${EMPTY}    ${is_percentage}=False
    Connect To Power Express Database    Desktop_Test
    ${fee_value}    Set Variable If    "${is_percentage}" == "True"    FeePercent    FeeAmount
    ${queryResults}    Query    SELECT TOP 1 ${fee_value} FROM [dbo].[TransactionFee] TF INNER JOIN [dbo].[TransactionFeeClientFeeGroup] TFCG ON TF.TransactionFeeId = TFCG.TransactionFeeId INNER JOIN [dbo].[ClientFeeGroup] CFG ON CFG.ClientFeeGroupId = TFCG.ClientFeeGroupId AND CFG.ClientFeeGroupName = '${client_fee_group_name}' INNER JOIN [dbo].[BookingOrigination] BO ON BO.BookingOriginationCode = TF.BookingOriginationCode INNER JOIN [dbo].[PolicyRouting] PR ON PR.PolicyRoutingId = TF.PolicyRoutingId WHERE TF.TransactionTypeCode = '${transaction_type_code}' AND (TF.BookingOriginationCode = '${booking_origination_code}' OR TF.BookingOriginationCode = 'Any') AND TF.TravelIndicator = '${travel_indicator}' AND TF.TransactionFee like '%${transaction_fee}%' AND (PR.FromGlobalRegionCode = '${from_region_code}' AND (PR.ToCityCode = '${to_city_code}' OR PR.ToCountryCode = '${to_country_code}' OR PR.ToTravelPortCode = '${to_travelport_code}' OR PR.ToGlobalRegionCode = '${to_region_code}' OR PR.ToGlobalSubRegionCode = '${to_sub_region_code}'))
    ${queryResults}    Convert To String    ${queryResults[0]}
    ${queryResults}    Remove All Non-Integer (retain period)    ${queryResults}
    Disconnect From Database
    [Return]    ${queryResults}

Get Transaction Fee From DB (From Sub Region)
    [Arguments]    ${client_fee_group_name}    ${transaction_type_code}    ${booking_origination_code}    ${travel_indicator}    ${from_sub_region_code}    ${to_travelport_code}=${EMPTY}
    ...    ${to_city_code}=${EMPTY}    ${to_country_code}=${EMPTY}    ${to_sub_region_code}=${EMPTY}    ${to_region_code}=${EMPTY}    ${transaction_fee}=${EMPTY}    ${is_percentage}=False
    Connect To Power Express Database    Desktop_Test
    ${fee_value}    Set Variable If    "${is_percentage}" == "True"    FeePercent    FeeAmount
    ${queryResults}    Query    SELECT TOP 1 ${fee_value} FROM [dbo].[TransactionFee] TF INNER JOIN [dbo].[TransactionFeeClientFeeGroup] TFCG ON TF.TransactionFeeId = TFCG.TransactionFeeId INNER JOIN [dbo].[ClientFeeGroup] CFG ON CFG.ClientFeeGroupId = TFCG.ClientFeeGroupId AND CFG.ClientFeeGroupName = '${client_fee_group_name}' INNER JOIN [dbo].[BookingOrigination] BO ON BO.BookingOriginationCode = TF.BookingOriginationCode INNER JOIN [dbo].[PolicyRouting] PR ON PR.PolicyRoutingId = TF.PolicyRoutingId WHERE TF.TransactionTypeCode = '${transaction_type_code}' AND (TF.BookingOriginationCode = '${booking_origination_code}' OR TF.BookingOriginationCode = 'Any') AND TF.TravelIndicator = '${travel_indicator}' AND TF.TransactionFee like '%${transaction_fee}%' AND (PR.FromGlobalSubRegionCode = '${from_sub_region_code}' AND (PR.ToCityCode = '${to_city_code}' OR PR.ToCountryCode = '${to_country_code}' OR PR.ToTravelPortCode = '${to_travelport_code}' OR PR.ToGlobalRegionCode = '${to_region_code}' OR PR.ToGlobalSubRegionCode = '${to_sub_region_code}'))
    ${queryResults}    Convert To String    ${queryResults[0]}
    ${queryResults}    Remove All Non-Integer (retain period)    ${queryResults}
    Disconnect From Database
    [Return]    ${queryResults}

Get Transaction Fee From DB (From Travelport)
    [Arguments]    ${client_fee_group_name}    ${transaction_type_code}    ${booking_origination_code}    ${travel_indicator}    ${from_travelport_code}    ${to_travelport_code}=${EMPTY}
    ...    ${to_city_code}=${EMPTY}    ${to_country_code}=${EMPTY}    ${to_sub_region_code}=${EMPTY}    ${to_region_code}=${EMPTY}    ${transaction_fee}=${EMPTY}    ${is_percentage}=False
    Connect To Power Express Database    Desktop_Test
    ${fee_value}    Set Variable If    "${is_percentage}" == "True"    FeePercent    FeeAmount
    ${queryResults}    Query    SELECT TOP 1 ${fee_value} FROM [dbo].[TransactionFee] TF INNER JOIN [dbo].[TransactionFeeClientFeeGroup] TFCG ON TF.TransactionFeeId = TFCG.TransactionFeeId INNER JOIN [dbo].[ClientFeeGroup] CFG ON CFG.ClientFeeGroupId = TFCG.ClientFeeGroupId AND CFG.ClientFeeGroupName = '${client_fee_group_name}' INNER JOIN [dbo].[BookingOrigination] BO ON BO.BookingOriginationCode = TF.BookingOriginationCode INNER JOIN [dbo].[PolicyRouting] PR ON PR.PolicyRoutingId = TF.PolicyRoutingId WHERE TF.TransactionTypeCode = '${transaction_type_code}' AND (TF.BookingOriginationCode = '${booking_origination_code}' OR TF.BookingOriginationCode = 'Any') AND TF.TravelIndicator = '${travel_indicator}' AND TF.TransactionFee like '%${transaction_fee}%' AND (PR.FromTravelPortCode = '${from_travelport_code}' AND (PR.ToCityCode = '${to_city_code}' OR PR.ToCountryCode = '${to_country_code}' OR PR.ToTravelPortCode = '${to_travelport_code}' OR PR.ToGlobalRegionCode = '${to_region_code}' OR PR.ToGlobalSubRegionCode = '${to_sub_region_code}'))
    ${queryResults}    Convert To String    ${queryResults[0]}
    ${queryResults}    Remove All Non-Integer (retain period)    ${queryResults}
    Disconnect From Database
    [Return]    ${queryResults}

Get Transaction Fee From DB
    [Arguments]    ${client_fee_group_name}    ${base_nett_fare}    ${from_routing_code}    ${to_routing_code}    ${travel_indicator}    ${booking_origination_code}=Offline
    ...    ${transaction_type_code}=${EMPTY}
    [Documentation]    ---${travel_indicator}=I or D (International or Domestic)
    ...    ---${booking_origination_code}=Offline/Online<br/>
    ...    --- ${transaction_type_code}=Online/Assist/User Defined/ETS/User Defined 2<br/>
    Connect To Power Express Database    Desktop_Test
    Comment    ${base_nett_fare}    Round Apac    ${base_nett_fare}    SG
    @{queryResults}    Query    SELECT CI.CityCode, CO.CountryCode, GS.GlobalSubRegionCode, GS.GlobalRegionCode FROM TravelPort TP JOIN City CI ON TP.CityCode = CI.CityCode JOIN Country CO ON CI.CountryCode = CO.CountryCode JOIN GlobalSubRegion GS ON CO.GlobalSubRegionCode = GS.GlobalSubRegionCode JOIN GlobalRegion GR ON GS.GlobalRegionCode = GR.GlobalRegionCode WHERE TP.TravelPortCode = '${from_routing_code}'
    ${values}    Convert To List    ${queryResults[0]}
    ${from_city_code}    Set Variable    ${values[0]}
    ${from_country_code}    Set Variable    ${values[1]}
    ${from_global_subregion_code}    Set Variable    ${values[2]}
    ${from_global_region_code}    Set Variable    ${values[3]}
    @{queryResults}    Query    SELECT CI.CityCode, CO.CountryCode, GS.GlobalSubRegionCode, GS.GlobalRegionCode FROM TravelPort TP JOIN City CI ON TP.CityCode = CI.CityCode JOIN Country CO ON CI.CountryCode = CO.CountryCode JOIN GlobalSubRegion GS ON CO.GlobalSubRegionCode = GS.GlobalSubRegionCode JOIN GlobalRegion GR ON GS.GlobalRegionCode = GR.GlobalRegionCode WHERE TP.TravelPortCode = '${to_routing_code}'
    ${values}    Convert To List    ${queryResults[0]}
    ${to_city_code}    Set Variable    ${values[0]}
    ${to_country_code}    Set Variable    ${values[1]}
    ${to_global_subregion_code}    Set Variable    ${values[2]}
    ${to_global_region_code}    Set Variable    ${values[3]}
    ${queryResults}    Run Keyword If    '${transaction_type_code}' == '${EMPTY}'    Query    SELECT TOP 1 FeeAmount, FeePercent, TF.FeeCategory, TF.TravelIndicator, TF.MinimumTicketPrice FROM [dbo].[TransactionFee] TF INNER JOIN [dbo].[TransactionFeeClientFeeGroup] TFCG ON TF.TransactionFeeId = TFCG.TransactionFeeId INNER JOIN [dbo].[ClientFeeGroup] CFG ON CFG.ClientFeeGroupId = TFCG.ClientFeeGroupId AND CFG.ClientFeeGroupName = '${client_fee_group_name}' INNER JOIN [dbo].[BookingOrigination] BO ON BO.BookingOriginationCode = TF.BookingOriginationCode INNER JOIN [dbo].[PolicyRouting] PR ON PR.PolicyRoutingId = TF.PolicyRoutingId WHERE TF.TravelIndicator = '${travel_indicator}' and TF.BookingOriginationCode = '${booking_origination_code}' and TF.FeeCategory = 'Destination' AND ((PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromCityCode = '${from_city_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromGlobalFlag = 1 AND PR.ToCityCode = '${to_city_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToGlobalSubRegionCode = '${to_global_subregion_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToGlobalFlag = 1))
    ...    ELSE    Query    SELECT TOP 1 FeeAmount, FeePercent, TF.FeeCategory, TF.TravelIndicator, TF.MinimumTicketPrice FROM [dbo].[TransactionFee] TF INNER JOIN [dbo].[TransactionFeeClientFeeGroup] TFCG ON TF.TransactionFeeId = TFCG.TransactionFeeId INNER JOIN [dbo].[ClientFeeGroup] CFG ON CFG.ClientFeeGroupId = TFCG.ClientFeeGroupId AND CFG.ClientFeeGroupName = '${client_fee_group_name}' INNER JOIN [dbo].[BookingOrigination] BO ON BO.BookingOriginationCode = TF.BookingOriginationCode INNER JOIN [dbo].[PolicyRouting] PR ON PR.PolicyRoutingId = TF.PolicyRoutingId WHERE TF.TravelIndicator = '${travel_indicator}' and TF.BookingOriginationCode = ${booking_origination_code} AND TF.TransactionTypeCode = '${transaction_type_code}' and TF.FeeCategory = 'Destination' AND ((PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromCityCode = '${from_city_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromGlobalFlag = 1 AND PR.ToCityCode = '${to_city_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToGlobalSubRegionCode = '${to_global_subregion_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToGlobalFlag = 1))
    ${queryResults}    Run Keyword If    "${queryResults}" != "[]"    Set Variable    ${queryResults}
    ...    ELSE IF    '${transaction_type_code}' == '${EMPTY}'    Query    SELECT TOP 1 FeeAmount, FeePercent, TF.FeeCategory, TF.TravelIndicator, TF.MinimumTicketPrice FROM [dbo].[TransactionFee] TF INNER JOIN [dbo].[TransactionFeeClientFeeGroup] TFCG ON TF.TransactionFeeId = TFCG.TransactionFeeId INNER JOIN [dbo].[ClientFeeGroup] CFG ON CFG.ClientFeeGroupId = TFCG.ClientFeeGroupId AND CFG.ClientFeeGroupName = '${client_fee_group_name}' INNER JOIN [dbo].[BookingOrigination] BO ON BO.BookingOriginationCode = TF.BookingOriginationCode INNER JOIN [dbo].[PolicyRouting] PR ON PR.PolicyRoutingId = TF.PolicyRoutingId WHERE TF.TravelIndicator = '${travel_indicator}' and TF.BookingOriginationCode = '${booking_origination_code}' and TF.MinimumTicketPrice IS NULL AND ((PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromCityCode = '${from_city_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromGlobalFlag = 1 AND PR.ToCityCode = '${to_city_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToGlobalSubRegionCode = '${to_global_subregion_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToGlobalFlag = 1))
    ...    ELSE    Query    SELECT TOP 1 FeeAmount, FeePercent, TF.FeeCategory, TF.TravelIndicator, TF.MinimumTicketPrice FROM [dbo].[TransactionFee] TF INNER JOIN [dbo].[TransactionFeeClientFeeGroup] TFCG ON TF.TransactionFeeId = TFCG.TransactionFeeId INNER JOIN [dbo].[ClientFeeGroup] CFG ON CFG.ClientFeeGroupId = TFCG.ClientFeeGroupId AND CFG.ClientFeeGroupName = '${client_fee_group_name}' INNER JOIN [dbo].[BookingOrigination] BO ON BO.BookingOriginationCode = TF.BookingOriginationCode INNER JOIN [dbo].[PolicyRouting] PR ON PR.PolicyRoutingId = TF.PolicyRoutingId WHERE TF.TravelIndicator = '${travel_indicator}' and TF.BookingOriginationCode = ${booking_origination_code} AND TF.TransactionTypeCode = '${transaction_type_code}' and TF.MinimumTicketPrice IS NULL AND ((PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromTravelPortCode = '${from_routing_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromCityCode = '${from_city_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToTravelPortCode = '${to_routing_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromCityCode = '${from_city_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromCountryCode = '${from_country_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromGlobalSubRegionCode = '${from_global_subregion_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToCityCode = '${to_city_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromGlobalRegionCode = '${from_global_region_code}' AND PR.ToGlobalFlag = 1) OR (PR.FromGlobalFlag = 1 AND PR.ToCityCode = '${to_city_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToCountryCode = '${to_country_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToGlobalSubRegionCode = '${to_global_subregion_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToGlobalRegionCode = '${to_global_region_code}') OR (PR.FromGlobalFlag = 1 AND PR.ToGlobalFlag = 1))
    ${queryResults}    Run Keyword If    "${queryResults}" != "[]"    Set Variable    ${queryResults}
    ...    ELSE IF    "${queryResults}" == "[]" and '${transaction_type_code}' == '${EMPTY}'    Query    SELECT TOP 1 FeeAmount, FeePercent, TF.FeeCategory, TF.TravelIndicator, TF.MinimumTicketPrice FROM [dbo].[TransactionFee] TF INNER JOIN [dbo].[TransactionFeeClientFeeGroup] TFCG ON TF.TransactionFeeId = TFCG.TransactionFeeId INNER JOIN [dbo].[ClientFeeGroup] CFG ON CFG.ClientFeeGroupId = TFCG.ClientFeeGroupId AND CFG.ClientFeeGroupName = '${client_fee_group_name}' INNER JOIN [dbo].[BookingOrigination] BO ON BO.BookingOriginationCode = TF.BookingOriginationCode INNER JOIN [dbo].[PolicyRouting] PR ON PR.PolicyRoutingId = TF.PolicyRoutingId WHERE TF.TravelIndicator = '${travel_indicator}' and TF.BookingOriginationCode = '${booking_origination_code}' AND TF.MinimumTicketPrice <= ${base_nett_fare} AND TF.MaximumTicketPrice >= ${base_nett_fare}
    ...    ELSE IF    "${queryResults}" == "[]" and '${transaction_type_code}' != '${EMPTY}'    Query    SELECT TOP 1 FeeAmount, FeePercent, TF.FeeCategory, TF.TravelIndicator, TF.MinimumTicketPrice FROM [dbo].[TransactionFee] TF INNER JOIN [dbo].[TransactionFeeClientFeeGroup] TFCG ON TF.TransactionFeeId = TFCG.TransactionFeeId INNER JOIN [dbo].[ClientFeeGroup] CFG ON CFG.ClientFeeGroupId = TFCG.ClientFeeGroupId AND CFG.ClientFeeGroupName = '${client_fee_group_name}' INNER JOIN [dbo].[BookingOrigination] BO ON BO.BookingOriginationCode = TF.BookingOriginationCode INNER JOIN [dbo].[PolicyRouting] PR ON PR.PolicyRoutingId = TF.PolicyRoutingId WHERE TF.TravelIndicator = '${travel_indicator}' and TF.BookingOriginationCode = '${booking_origination_code}' AND TF.TransactionTypeCode = '${transaction_type_code}' AND TF.MinimumTicketPrice <= ${base_nett_fare} AND TF.MaximumTicketPrice >= ${base_nett_fare}
    Disconnect From Database
    [Return]    ${queryResults}
